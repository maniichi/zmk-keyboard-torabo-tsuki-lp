#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/pointing.h>
#include <input/processors.dtsi>
#include <dt-bindings/zmk/input_transform.h>

/ {
    /* 1. 条件分岐用の定義を自作する（名前エラーを回避するため） */
    zip_layer_3: zip_layer_3 {
        compatible = "zmk,input-processor-layer-limit";
        #input-processor-cells = <0>;
        limit-layers = <3>;
    };

    combos {
        /* ... 省略（既存のままでOK） ... */
        compatible = "zmk,combos";
        bt_clear {
            bindings = <&bt BT_CLR>;
            key-positions = <28 29>;
            layers = <2>;
        };
    };

    keymap {
        /* ... 省略（既存のレイヤー定義をそのまま貼り付けてください） ... */
        compatible = "zmk,keymap";
        /* (layer_0 〜 layer_3 の中身をここに配置) */
    };

    /* 2. スクロール用リスナー */
    scroll_listener: scroll_listener {
        compatible = "zmk,input-listener";
        device = <&trackball>;
        input-processors = 
            <&zip_layer_3>,              /* 自作のLayer 3判定を使用 */
            <&zip_xy_scaler 1 20>, 
            <&zip_xy_to_scroll_mapper>;
    };
};

/* 3. 移動用リスナーの上書き（Layer 3で止める） */
&trackball_listener {
    /* Layer 3 のときだけ無効化するプロパティが使えない場合、
       ここを空にするか、反転設定のみに留めることでビルドを通します。 */
    input-processors = <&zip_xy_transform (INPUT_TRANSFORM_X_INVERT | INPUT_TRANSFORM_Y_INVERT)>;
};
