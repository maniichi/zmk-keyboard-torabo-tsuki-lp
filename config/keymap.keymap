#include <behaviors.dtsi>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/pointing.h>
#include <input/processors.dtsi>
#include <dt-bindings/zmk/input_transform.h>

/ {
    /* 前回の自作定義（zip_layer_3）はエラーの元なので削除しました */

    combos {
        compatible = "zmk,combos";
        bt_clear {
            bindings = <&bt BT_CLR>;
            key-positions = <28 29>;
            layers = <2>;
        };
    };

    keymap {
        /* ここは既存のレイヤー定義をそのまま維持してください */
        compatible = "zmk,keymap";
        /* ... layer_0 〜 layer_3 の中身 ... */
    };

    /* * 【重要】レイヤー制限（layers = <3>;）が使える可能性がある 
     * 標準の input-listener binding を使わず、
     * 最もシンプルな構成で記述します。
     */
    scroll_listener {
        compatible = "zmk,input-listener";
        device = <&trackball>;
        input-processors = <&zip_xy_scaler 1 20>, <&zip_xy_to_scroll_mapper>;
    };
};

/* * ここで「レイヤー制限」をかけます。
 * listener プロパティではなく、ZMKの「一括適用」の仕組みを使います。
 */
&scroll_listener {
    /* これでお使いの環境が「layers」をプロパティとして持っていれば通ります */
    /* もしこれで「layersが無い」とエラーが出る場合は、この1行を消せば「全レイヤーでスクロール」になります */
    layers = <3>; 
};

&trackball_listener {
    /* Layer 3 のときは移動を止める（もしエラーが出るならこの &trackball_listener 枠ごと消してください） */
    exclude-layers = <3>;
    input-processors = <&zip_xy_transform (INPUT_TRANSFORM_X_INVERT | INPUT_TRANSFORM_Y_INVERT)>;
};
